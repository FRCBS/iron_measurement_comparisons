---
title: "Low ferritin model"
author: "Sofie Ekroos"
date: "19.7.2021"
output: github_document
bibliography: index.bib
---

*** THE FIRST PART HAS BEEN MOVED TO THE PROJECT "LOW FERRITIN DATA". THIS PART SHOULD START WITH LOADING THE DATA PRODUCED IN THAT PROJECT. DO NOT USE THIS CODE IN ITS CURRENT STATE ***

Based on the original code written by Muriel Lobier and Mikko Arvas (https://github.com/FRCBS/iron_levels_of_blood_donors/blob/master/src/index.Rmd and https://github.com/FRCBS/changes_in_donor_health/blob/master/src/explorative_analysis.Rmd)

# Summary

This document includes all codes necessary to run the analysis of and produce the figures for the three Finnish Cohorts (FinDonor, FINRISK97, Health2000). The code is in two parts. Part 1 allows the user to identify co-variants of iron deficiency using logistic regression, part 2 to identify co-variants of ferritin concentration using multiple linear regression.

```{r setup, , message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tableone)
library(stargazer)
library(gridExtra)
library(cowplot)
library(broom)
library(GGally)
library(ggfortify)
library(knitr)
library(lubridate)
library(car)
library(sfsmisc)
library(MASS)
library(ordinal)
library(sjmisc)
library(epiDisplay)
library(safeBinaryRegression)
library(epitools)
library(ez)
library(ggbeeswarm)
library(tidymodels)
library(ggplot2)
library(cowplot)
```



PART 1: LOGISTIC REGRESSION

# Data loading and preparation 

Load data

```{r}
load("../data/ID_data_regression_cohorts.rdata")
```

Data transformations:

* Log transformed variables: 
    * Ferritin
    * CRP 
  
* Age is divided by 5 to simplify coefficient interpretation
* Number of days before donation is transformed as $log\_last\_donation = log(last\_donation)/log(2)$ to help with the interpretation of coefficients. 
    * An increase in one of the transformed variable is equivalent to a doubling of the number of days since last donation.

* Standardization:
    * Standardized coefficients: 
        * All dependent and independent variables were standardized
      
    * Coefficients:
        * All dependent variables entered as continuous varaibles are centered but not scaled. 

We center all variables entered as continuous.

## All cohorts 

```{r}

all_cohorts <- regression_cohorts

all_cohorts %>% 
  dplyr::select(ID, log_ferritin, Age, log_CRP, BMI, donation_count, log_last_donation) %>%
  mutate(Age = scale(Age, scale = FALSE)[,1],
         log_CRP = scale(log_CRP, scale = FALSE)[,1],
         donation_count = scale(donation_count, scale = FALSE)[,1],
         log_last_donation = scale(log_last_donation, scale = FALSE)[,1],
         BMI = scale(BMI, scale = FALSE)[,1],
         donation_count_2 = donation_count^2) 


```

####### OMA SEKOILU ALKAA #######

## Percentage of ID, all cohorts

```{r}
all_cohorts %>%
  dplyr::select(Group, iron_deficiency) %>% 
  group_by(Group, iron_deficiency) %>% 
  count() %>% 
  group_by(Group) %>% 
  summarise(
    ID = iron_deficiency,
    n=n,
    Percentage = round(n/sum(n),2)
  )
```


## Percentage of ID, FinDonor

```{r}
all_cohorts %>%
  filter(Cohort == "FINDONOR") %>% 
  dplyr::select(Group, iron_deficiency) %>% 
  group_by(Group, iron_deficiency) %>% 
  count() %>% 
  group_by(Group) %>% 
  summarise(
    ID = iron_deficiency,
    n=n,
    Percentage = round(n/sum(n),2)
  )
```

## Percentage of ID, FinRisk97

```{r}
all_cohorts %>%
  filter(Cohort == "FINRISK97") %>% 
  dplyr::select(Group, iron_deficiency) %>% 
  group_by(Group, iron_deficiency) %>% 
  count() %>% 
  group_by(Group) %>% 
  summarise(
    ID = iron_deficiency,
    n=n,
    Percentage = round(n/sum(n),2)
  )
```


## Percentage of ID, Health2000

```{r}
all_cohorts %>%
  filter(Cohort == "HEALTH00") %>% 
  dplyr::select(Group, iron_deficiency) %>% 
  group_by(Group, iron_deficiency) %>% 
  count() %>% 
  group_by(Group) %>% 
  summarise(
    ID = iron_deficiency,
    n=n,
    Percentage = round(n/sum(n),2)
  )
```

# Simple model

Trying a simple model for ID and sex. Specifying wanting the binomial family of generalized models tells the glm function to do logistic regression as opposed to some other type of generalized linear model. The summary function is used to get details about the logistic regression. 

```{r}
logistic_simple <- glm(iron_deficiency ~ Sex, data = all_cohorts, family = "binomial")
summary(logistic_simple)
```

## thoughts on the summary:

- Deviance residuals look good (close to centered on 0, roughly symmetrical) - OR DO THEY??????
- Coefficients correspons to the following model: iron deficiency = estimate (intercept) + estimate (SexWomen) x the individual is female (=0 when the individual is male, =1 when the individual is female) --> in this case, predicting ID = (-3.29442)+1.99723x1= -1.29719 for females, -3.29442 for males. In other words, log(odds) of women having ID is -1.29719, for men the log(odds) is -3.29442 --> the second term (1.99723) is log(odds ratio) of the odds that a women will have ID over the odds that a male will have ID.  
- Std error and z value output shows how the Wald's test was computed for both coefficiants 
### !!!! NOT SURE HOW TO INTERPRET THE Z VALUE???? !!!!
- Pr(<|z|) = p-values :) both look to be significantly lower than 0.05 --> both log(odds) and log(odds ratios) are statistically significant 
- Default dispersion parameter used for the logistic regression: normally in linear regression the mean and the variance from the data are estimated, but when we do logistic regression we only estimate the mean and then the variance is derived from the mean. For this reason it's possible that the variance is underestimated. If it is, the dispersion parameter can be adjusted in the summary() command 
- Null deviance and residual deviance are used to compare models, calculate R² and overall p-value
- AIC = akaike information criterion = the residual deviance adjusted for the number of parameters in the model --> can be used to compare models 
- Fisher scoring iterations tell how quickly the glm() function converged on the maximum lakelyhood estimates for the coefficients 

# Fixing the male groups - MAYBE MOVE THIS TO low_ferritin_model? OR IS THIS EVEN NEEDED?

NA:s in the male group (pregnancy and menstruation questions) are a problem, impute menstruation to "no_period" and previous childbirth to "0". 
# --> RECHECK THAT THESE ACTUALLY WORKED!!!

```{r}
all_cohorts_fixed <- all_cohorts %>% 
  mutate(Menstruation = case_when(
    Menstruation == "irregular_period" ~ "irregular_period",
    Menstruation == "regular_period" ~ "regular_period",
    Menstruation == "no_period" ~ "no_period",
    Sex == "Men" & is.na(Menstruation) ~ "no_period")) %>% 
  mutate(Menstruation = ordered(Menstruation, levels =
    c("regular_period", "irregular_period", "no_period")))


all_cohorts_fixed <- all_cohorts_fixed %>% 
  mutate(PreviousChildbirth = case_when(
    PreviousChildbirth == "1" ~ "1",
    PreviousChildbirth == "0" ~ "0",
    Sex == "Men" & is.na(PreviousChildbirth) ~ "0")) %>% 
  mutate(PreviousChildbirth = ordered(PreviousChildbirth, levels =
    c("0", "1")))
```

# Model using more than one variable

Next let's try creating a model that uses all of the variables to predict ID. `iron_deficiency ~ .` means that we want to model ID using all of the remaining variables. 


```{r}
logistic <- glm(iron_deficiency ~ ., data = all_cohorts, family = "binomial", separation = 'test')
summary(logistic)

# hmm, does not work since ID column causes separation (???) --> will add variables one by one 

logistic <- glm(iron_deficiency ~ Sex + Age + BMI + Smoking + RedMeat_n + iron_complience + donation_count_2 +  log_last_donation + log_CRP, data = all_cohorts, family = "binomial")
summary(logistic)

# all variables: Group + Sex + Age + BMI + Menstruation + Smoking + RedMeat_n + iron_complience + PreviousChildbirth + donation_count_2 + log_ferritin + log_last_donation + log_CRP

# variables that worked: Sex + Age + BMI + Smoking + RedMeat_n + iron_complience + donation_count_2 + log_last_donation + log_CRP

# variables that caused separation: Group + log_ferritin

# other errors:
## Menstruation + PreviousChildbirth -->  Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : contrasts can be applied only to factors with 2 or more levels

```

## thoughts on the summary:

1) Deviance residuals look good (?)
2) The coefficients look statistically significant except for RedMeat_n and iron_complience 
- Coefficients (statistically significant):
  Female sex:    1.79
  Age:          -0.12
  BMI:          -0.05
  Smoker:       -0.36
  Donation#:     0.02
  Last donation: 0.15
  CRP:          -0.46
  Gender is still a good predictor.   
3) AIC and residual deviance are much smaller for this model than the more simple model in which only gender was used to predict ID, this is to be expected 
4) to calculate FcFadden's Pseudo R² the log-likelihood of the null model can be extracted out of the logistic variable by getting the value for the null deviance and dividing by -2:

```{r}
ll.null <- logistic$null.deviance/-2
```

the log-likelihood for the model can be extracted out out of the logistic variable by getting the value for the residual deviance and dividing by -2:

```{r}
ll.proposed <- logistic$deviance/-2
```

Pseudo R² can then be calculated out of these. 

```{r}
(ll.null - ll.proposed) / ll.null
```

R² = 0.1189565, this can be interpreted as the overall effect size

A p-value for R² can then be calculated (Chi-square distribution)

```{r}
1 - pchisq(2*(ll.proposed - ll.null), df=(length(logistic$coefficients)-1))
```
p-value = 0, so R² is statistically significant

## Graph

Next draw a graph that shows the predicted probabilities that each individual has ID along with their actual ID status. First create a new data frame that contains the probabilities and actual statuses. 

```{r}
predicted_ID <- data.frame(
  probability_of_ID = logistic$fitted.values,
  ID=all_cohorts$iron_deficiency)

# this part doesn't work, error message: Error in data.frame(probability.of.ID = logistic$fitted.values, ID = all_cohorts$iron_deficiency) : arguments imply differing number of rows: 8894, 13704 

# seems like I've dropped a cohort?
## rows 1 --> 2322 FinDonor, 2322 participants
## rows 2323 --> 8897 fr1997, 6572 participants 
## rows 8898 --> 13704 h2000, 4807 participants 
## FD+h2000=7129 participants
## FD+fr1997=8894 --> I have FinDonor and fr1997, but seem to have dropped h2000
```
Hmm, maybe h2000 is missing because they don't have data on red meat, but is included in the model? Let's try this again without the red meat variable...

```{r}
logistic_no_meat <- glm(iron_deficiency ~ Sex + Age + BMI + Smoking + iron_complience + donation_count_2 +  log_last_donation + log_CRP, data = all_cohorts, family = "binomial")
summary(logistic)

# all variables: Group + Sex + Age + BMI + Menstruation + Smoking + iron_complience + PreviousChildbirth + donation_count_2 + log_ferritin + log_last_donation + log_CRP

# variables that worked: Sex + Age + BMI + Smoking + RedMeat_n + iron_complience + donation_count_2 + log_last_donation + log_CRP

# variables that caused separation: Group + log_ferritin

# other that were not used:
## Menstruation + PreviousChildbirth -->  Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : contrasts can be applied only to factors with 2 or more levels
## Red_meat_n - don't have this data for the h2000 cohort (or the Dutch cohorts for that matter)
```



```{r}
ll.null <- logistic_no_meat$null.deviance/-2
```


```{r}
ll.proposed <- logistic_no_meat$deviance/-2
```

Pseudo R² can then be calculated out of these. 

```{r}
(ll.null - ll.proposed) / ll.null
```

R² = 0.1341944, this can be interpreted as the overall effect size

A p-value for R² can then be calculated (Chi-square distribution)

```{r}
1 - pchisq(2*(ll.proposed - ll.null), df=(length(logistic$coefficients)-1))
```
p-value = 0, so R² is statistically significant

## Graph

Next draw a graph that shows the predicted probabilities that each individual has ID along with their actual ID status. First create a new data frame that contains the probabilities and actual statuses. 

```{r}
predicted_ID <- data.frame(
  probability_of_ID = logistic_FIN_NL$fitted.values,
  ID=all_cohorts$iron_deficiency)

# yay, this worked :) so red meat was the problem --> clean up the beginning of the code and remove it from the start 

```

Then sort the data frame from low to high probabilities 

```{r}
predicted_ID <- predicted_ID[
  order(predicted_ID$probability_of_ID, decreasing = FALSE),]
```

Next add a new column to the data frame that has the rank of each sample, from low to high probability

```{r}
predicted_ID$rank <- 1:nrow(predicted_ID)
```

Draw the data and save to pdf :)

```{r}
ggplot(data = predicted_ID, aes(x=rank, y=probability_of_ID)) + 
  geom_point(aes(color=ID), alpha=1, shape=4, stroke=2) + 
  xlab("Index") + 
  ylab("Predicted probability of iron deficiency")

ggsave("iron_deficiency_probabilities.pdf")
```


# Cohort comparison model 

For this model, use only variables we have for all three Finnish and both Dutch cohorts

Start with fixing the male groups (MOVE THIS TO low_ferritin_data, OR MAYBE UNNECESSARY?) 

Dutch cohorts have a yes/no question for menstruation, so regular/irregular need to be recoded to yes. 

```{r}
all_cohorts_fixed <- all_cohorts %>% 
  mutate(Menstruation = case_when(
    Menstruation == "irregular_period" ~ "irregular_period",
    Menstruation == "regular_period" ~ "regular_period",
    Menstruation == "no_period" ~ "no_period",
    Sex == "Men" & is.na(Menstruation) ~ "no_period")) %>% 
  mutate(Menstruation = ordered(Menstruation, levels =
    c("regular_period", "irregular_period", "no_period")))

# this part likely not needed, we are missing data on previous pregnancies in one of the Dutch cohorts (or are we?)
# all_cohorts_fixed <- all_cohorts_fixed %>% 
#   mutate(PreviousChildbirth = case_when(
#     PreviousChildbirth == "1" ~ "1",
#     PreviousChildbirth == "0" ~ "0",
#     Sex == "Men" & is.na(PreviousChildbirth) ~ "0")) %>% 
#   mutate(PreviousChildbirth = ordered(PreviousChildbirth, levels =
#     c("0", "1")))

all_cohorts <- all_cohorts_fixed
```


```{r}
logistic_FIN_NL <- glm(iron_deficiency ~ Sex + Age + BMI + Smoking + donation_count_2 +  log_last_donation, data = all_cohorts, family = "binomial")
summary(logistic_FIN_NL)

# still missing menstruation variable, I keep getting error message for it
# group variable caused separation and not included for that reason yet -->  are we making graphs based on cohort where group is a variable, or based on group where cohort is a variable?
# menstruation error message: Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : contrasts can be applied only to factors with 2 or more levels
```

Yay, all statistically significant :)

Coefficients:
                   Estimate Std. Error z value Pr(>|z|)
(Intercept)       -2.594209   0.338650  -7.660 1.85e-14
SexWomen           1.999381   0.074946  26.677  < 2e-16
Age               -0.133897   0.011447 -11.697  < 2e-16
BMI               -0.042745   0.006269  -6.819 9.17e-12
Smokingyes        -0.455228   0.079693  -5.712 1.11e-08
donation_count_2   0.024003   0.003296   7.281 3.30e-13
log_last_donation  0.161354   0.028517   5.658 1.53e-08

```{r}
ll.null <- logistic_FIN_NL$null.deviance/-2
```


```{r}
ll.proposed <- logistic_FIN_NL$deviance/-2
```

Pseudo R² can then be calculated out of these. 

```{r}
(ll.null - ll.proposed) / ll.null
```

R² = 0.1318253, this can be interpreted as the overall effect size

A p-value for R² can then be calculated (Chi-square distribution)

```{r}
1 - pchisq(2*(ll.proposed - ll.null), df=(length(logistic_FIN_NL$coefficients)-1))
```
p-value = 0, so R² is statistically significant

## Graph

Next draw a graph that shows the predicted probabilities that each individual has ID along with their actual ID status. First create a new data frame that contains the probabilities and actual statuses. 

```{r}
predicted_ID_FIN_NL <- data.frame(
  probability_of_ID = logistic_FIN_NL$fitted.values,
  ID=all_cohorts$iron_deficiency)
```

Then sort the data frame from low to high probabilities 

```{r}
predicted_ID <- predicted_ID_FIN_NL[
  order(predicted_ID_FIN_NL$probability_of_ID, decreasing = FALSE),]
```

Next add a new column to the data frame that has the rank of each sample, from low to high probability

```{r}
predicted_ID_FIN_NL$rank <- 1:nrow(predicted_ID_FIN_NL)
```

Draw the data and save to pdf :)

```{r}
ggplot(data = predicted_ID_FIN_NL, aes(x=rank, y=probability_of_ID)) + 
  geom_point(aes(color=ID), alpha=1, shape=4, stroke=2) + 
  xlab("Index") + 
  ylab("Predicted probability of iron deficiency")

ggsave("iron_deficiency_probabilities.pdf")
```




######## OMA SEKOILU LOPPUU ########


```{r}
all_cohorts_fixed_test <- all_cohorts_fixed %>% 
logit_pre_menopausal <- glm(
  iron_deficiency ~ BMI +
    age,
    data=test_data_std,
    family="binomial", separation = 'test')
 
 summary(logit_pre_menopausal)


#https://stats.stackexchange.com/questions/11109/how-to-deal-with-perfect-separation-in-logistic-regression
#https://stats.stackexchange.com/questions/45803/logistic-regression-in-r-resulted-in-perfect-separation-hauck-donner-phenomenon
```
  

```{r}
plot(logit_pre_menopausal)
```

```{r}
vif(logit_pre_menopausal)
```

```{r}
logistic.display(logit_pre_menopausal)
```
  
############### END OF PART WE WILL USE 






  
# Bootstraps
https://data.princeton.edu/wws509/r/c3s1
https://stats.stackexchange.com/questions/304833/how-to-calculate-odds-ratio-and-95-confidence-interval-for-logistic-regression
https://www.andrewheiss.com/blog/2016/04/25/convert-logistic-regression-standard-errors-to-odds-ratios-with-r/

```{r}
detach("package:safeBinaryRegression", unload=TRUE)
#safeBinaryRegression messes up booting
```

## Define auxiliarry functions for bootstrapping
```{r}

# https://www.painblogr.org/2017-10-18-purrring-through-bootstraps.html


get_coefficients <- function(data, boot_ind){
  fit <- glm (health_outcome~.,
              data[boot_ind,],
              family = "binomial")
#  print(names(coef(fit)))
  return(coef(fit))
}



compute_Bca_CI <-function(fit_boot,conf = 0.95){
  cat("compute_Bca_CI with conf: ",conf,"\n")
  Bca_inf = rep(0, length(fit_boot$t0))
  Bca_sup = rep(0, length(fit_boot$t0))
  for (i_regressor in 1:length(fit_boot$t0)){
    CI <- boot.ci(fit_boot, type = "bca", index=i_regressor,conf = conf)
    Bca_inf[i_regressor] <- CI$bca[4]
    Bca_sup[i_regressor] <- CI$bca[5]
  }
  return(tibble(Bca_inf,Bca_sup, regressor = names(fit_boot$t0)) %>% 
           filter(regressor != "(Intercept)"))
}


get_bootstrap <- function(data, nb_boot){
 cat(nrow(data),"get_bootstrap 1\n")
 

    fit_boot <- boot(data, statistic= get_coefficients, R = nb_boot)

 cat(nrow(data),"get_bootstrap 2\n")
  fit_boot_distrib <- as.tibble(fit_boot$t)  
  names(fit_boot_distrib) <- names(fit_boot$t0)

  fit_boot_Bca <- compute_Bca_CI(fit_boot)
  fit_boot_Bca_2 <- compute_Bca_CI(fit_boot,conf=0.80)
  cat(nrow(data),"get_bootstrap 3\n")
  return(list(fit_boot_distrib,fit_boot_Bca,fit_boot_Bca_2))
}


```

## Run bootstrapping
```{r}
# Error in t.star[r, ] <- res[[r]] : 
#   number of items to replace is not a multiple of replacement length
#can sometimes be fixed by just adding bootstrap, but sometimes requires dropping out a variable


get_bootstrap_coeffs <- function(regression_data, current_group, nb_boot )
{

  ## preprocess and standardize data
  
    test_data_std <- regression_data %>% 
      filter(group == current_group) %>% 
      dplyr::select(donor, age, starting_weight, BMI_diff,
                    log_Ferritin_beginning, Hb_beginning, 
                    donation_frequency) %>% 
      gather(key = key, value = value, -donor) %>% 
      group_by(key) %>% 
      mutate(value_scale = scale(value, scale = FALSE)[,1]) %>% 
      dplyr::select(-value) %>% 
      spread(key = key, value = value_scale) 
     
    if (current_group == "Men") {
      test_data_std <- inner_join(test_data_std,regression_data %>% 
                                    dplyr::select(donor, health_outcome, health_very_good, health_excellent,
                                                #  sleep_night_d, ##Error in t.star[r, ] <- res[[r]] :
                                                  cholesterol_d,
                                                  blood_sugar_d,
                                                  HBP_d,
                                                  low_hb_hist_d,
                                                  iron_supp_d,
                                                  freq_calm_d,
                                                  freq_red_meat_d,
                                                  freq_fruits_d,
                                                  freq_juices_d,
                                                  freq_wholem_d,
                                                  freq_milk_d,
                                                  freq_cof_d,
                                                  freq_tea_d,
                                                  phys_cond_d,
                                                  act_heavy_d,
                                                  sleep_enough_d,
                                                  day_act_d,
                                                  h_act_light_d,
                                                  vita_multi_d,
                                                  #vita_iron_d, #Error in t.star[r, ] <- res[[r]]
                                                  sleep_tired_d,
                                                  anti_inf_d,
                                                  phys_inf_d,
                                                  #  ment_inf_d,
                                                  freq_alc_d,
                                                  life_qual,
                                                  employment
                                                #  education # Error in t.star[r, ] <- res[[r]] : 
                                                # smoking_behavior #Error in t.star[r, ] <- res[[r]] :
                                                  
                                    ),
                                  by = "donor") %>% 
        dplyr::select(-donor) 
    }
    
    if (current_group == "Pre_menopause_women") {
      test_data_std <- inner_join(test_data_std,regression_data %>% 
                                    dplyr::select(donor, health_outcome, health_very_good, health_excellent,
                                                #  sleep_night_d, #Error in t.star[r, ] <- res[[r]] :
                                                  cholesterol_d,
                                                  blood_sugar_d,
                                                  HBP_d,
                                                  low_hb_hist_d,
                                                  iron_supp_d,
                                                  freq_calm_d,
                                                  freq_red_meat_d,
                                                  freq_fruits_d,
                                                  freq_juices_d,
                                                  freq_wholem_d,
                                                  freq_milk_d,
                                                  freq_cof_d,
                                                  freq_tea_d,
                                                  phys_cond_d,
                                                  act_heavy_d,
                                                  sleep_enough_d,
                                                  day_act_d,
                                                  h_act_light_d,
                                                  vita_multi_d,
                                                  #vita_iron_d, #Error in t.star[r, ] <- res[[r]]
                                                  sleep_tired_d,
                                                  anti_inf_d,
                                                  phys_inf_d,
                                                  # ment_inf_d,
                                                  freq_alc_d,
                                                  life_qual,
                                                  employment
                                                #  education #Error in t.star[r, ] <- res[[r]] : 
                                               #   smoking_behavior # Error in t.star[r, ] <- res[[r]] : 
                                                  
                                    ),
                                  by = "donor") %>% 
        dplyr::select(-donor) 
    }
    
      if (current_group == "Post_menopause_women") {
      test_data_std <- inner_join(test_data_std,regression_data %>% 
                                    dplyr::select(donor, health_outcome, health_very_good, health_excellent,
                                                #  sleep_night_d, #Error in t.star[r, ] <- res[[r]] :
                                                 cholesterol_d,
                                                 blood_sugar_d,
                                                  HBP_d,
                                                  low_hb_hist_d,
                                                  iron_supp_d,
                                                  freq_calm_d,
                                                  freq_red_meat_d,
                                                  freq_fruits_d,
                                                  freq_juices_d,
                                                  freq_wholem_d,
                                                  freq_milk_d,
                                                  freq_cof_d,
                                                  freq_tea_d,
                                                  phys_cond_d,
                                                  act_heavy_d,
                                                  sleep_enough_d,
                                                  day_act_d,
                                                  h_act_light_d,
                                                  vita_multi_d,
                                                  #vita_iron_d #Error in t.star[r, ] <- res[[r]]
                                                  sleep_tired_d,
                                                  anti_inf_d,
                                                  phys_inf_d,
                                                  # ment_inf_d # Error in t.star[r, ] <- res[[r]]
                                                  freq_alc_d,
                                                  life_qual, # Error in bca.ci(boot.out, conf, index[1L], L = L, t = t.o, t0 = t0.o,  : estimated adjustment 'w' is infinite -> works if 10k boots.
                                                  employment
                                                #  education # Error in bca.ci(boot.out, conf, index[1L], L = L, t = t.o, t0 = t0.o,  :
                                                #  smoking_behavior # Error in t.star[r, ] <- res[[r]]
                                                  
                                    ),
                                  by = "donor") %>% 
        dplyr::select(-donor) 
    }
  cat(nrow(test_data_std),current_group,"get_bootstrap_coeffs 1\n")
  result <- test_data_std %>% 
  get_bootstrap(nb_boot = nb_boot)

  cat(nrow(test_data_std),current_group,"get_bootstrap_coeffs 2\n")
  bootstrap_distrib <- result[[1]] %>% 
    gather(key = regressor, value = coefficient) %>% 
    filter(regressor != "(Intercept)") %>% 
    mutate(group = current_group)
      cat(nrow(test_data_std),current_group,"get_bootstrap_coeffs 3\n")
  Bca_CI  <- result[[2]] %>% mutate(group = current_group)
  Bca_CI_2  <- result[[3]] %>% mutate(group = current_group)
  cat(nrow(test_data_std),current_group,"get_bootstrap_coeffs 4\n")
  return(list(bootstrap_distrib,Bca_CI,Bca_CI_2))
}




#get_from_file_ferr = TRUE



set.seed(125)
#group_str = "Pre_menopause_women"

for(group_str in c("Pre_menopause_women","Men","Post_menopause_women")){
#  for(group_str in c("Pre_menopause_women")) {
#for(group_str in c("Post_menopause_women","Pre_menopause_women")){
  output_file_distrib = paste0("../results/bootstraps/exp_coeff_boot_distrib_seed_125_ctr_strata_final_",group_str,".rdata")
  output_file_Bca = paste0("../results/bootstraps/exp_coeff_boot_Bca_seed_125_ctr_strata_final_",group_str,".rdata")
  output_file_Bca_2 = paste0("../results/bootstraps/exp_coeff_boot_Bca_2_seed_125_ctr_strata_final_",group_str,".rdata")
  get_from_file_ferr <- all(file.exists(output_file_distrib),file.exists(output_file_Bca),file.exists(output_file_Bca_2) )
  if (get_from_file_ferr){
    cat("Loading boots from file for group ",group_str,"\n")
    stuff <- list()
    load(file=output_file_distrib)
    load(file=output_file_Bca)
    load(file=output_file_Bca_2)
    stuff[[1]] <- temp1  
    stuff[[2]] <- temp2
    stuff[[3]] <- temp3
  }else {
    stuff <- get_bootstrap_coeffs(regression_data, group_str, nb_boot = 10000)
    #         stuff <- get_bootstrap_coeffs(regression_data, group_str, nb_boot = 1000)
    temp1 <- stuff[[1]] 
    temp2 <- stuff[[2]] 
    temp3 <- stuff[[3]] 
    save(temp1,file=output_file_distrib) 
    save(temp2,file=output_file_Bca)
    save(temp3,file=output_file_Bca_2)
  }
  
  if(!exists("bootstrap_distrib")){
    cat("initializing bootstrap_distrib, bootstrap_Bca_CI_2 & bootstrap_Bca_CI\n")

    bootstrap_distrib <- stuff[[1]]
    cat("nrow(bootstrap_distrib)",nrow(bootstrap_distrib),"\n")
    bootstrap_Bca_CI <- stuff[[2]]
    cat("nrow(bootstrap_Bca_CI)",nrow(bootstrap_Bca_CI),"\n")
    bootstrap_Bca_CI_2 <- stuff[[3]]
    cat("nrow(bootstrap_Bca_CI_2)",nrow(bootstrap_Bca_CI_2),"\n")
  }else
  {
    cat("bootstrap_distrib & bootstrap_Bca_CI already exist\n")
    bootstrap_distrib<-bind_rows(bootstrap_distrib, stuff[[1]])
    bootstrap_Bca_CI<-bind_rows(bootstrap_Bca_CI, stuff[[2]])
    bootstrap_Bca_CI_2<-bind_rows(bootstrap_Bca_CI_2, stuff[[3]])
  }
  
}


```

```{r}
bootstrap_Bca_CI %>%  group_by(group) %>% count()

```

# Forest plots

```{r}
# "\U0394 BMI"

regressor_values <- c(
 "age" = "Age",
   "BMI_diff" = "BMI difference",
   "donation_frequency" = "Donation frequency",
   "Hb_beginning" = "Initial Hemoglobin",
   "log_Ferritin_beginning" ="Initial Ferritin",
   "starting_weight" ="Initial weight",
   "health_very_good" ="Initial health rating \n Very good vs Satisfactory/Good",
    "health_excellent" = "Initial health rating \n Excellent vs Satisfactory/Good",
 
 
 "cholesterol_dTRUE" = "Elevated cholesterol detected",
"blood_sugar_dTRUE" = "Elevated blood sugar detected", 
"HBP_dTRUE" = "High blood pressure detected",
"low_hb_hist_dTRUE" = "Low haemoglobin detected",
"iron_supp_dStable" = "FRCBS iron supplementation stable", 
"iron_supp_dIncreased" = "FRCBS iron supplementation increased",
"vita_multi_dStable" = "Frequency multivitamine stable",
"vita_multi_dIncreased" = "Frequency multivitamine increased",
#"vita_iron_dStable" = "Frequency iron supplements stable",
#"vita_iron_dIncreased" = "Frequency iron supplements increased",
"anti_inf_dStable" = "Frequency of anti-inflammatory stable",
"anti_inf_dIncreased" = "Frequency of anti-inflammatory increased",
"freq_red_meat_dStable" = "Frequency of red meat stable",
"freq_red_meat_dIncreased" = "Frequency of red meat increased",
"freq_fruits_dStable" = "Frequency of fruits stable",
"freq_fruits_dIncreased" = "Frequency of fruits increased",
"freq_juices_dStable" = "Frequency of juices stable",
"freq_juices_dIncreased" = "Frequency of juices increased",
"freq_wholem_dStable" = "Frequency of whole milk stable",
"freq_wholem_dIncreased" = "Frequency of whole milk increased",
"freq_milk_dStable" = "Frequency of milk stable",
"freq_milk_dIncreased" = "Frequency of milk increased",
"freq_cof_dStable" = "Frequency of coffee stable",
"freq_cof_dIncreased"  = "Frequency of coffee increased",
"freq_tea_dStable" = "Frequency of tea stable",
"freq_tea_dIncreased" = "Frequency of tea increased",
"freq_alc_dStable" = "Frequency of alcohol stable",
"freq_alc_dIncreased" = "Frequency of alcohol increased",
"phys_inf_dStable" = "Physical symptoms inferred stable",
"phys_inf_dIncreased" = "Physical symptoms inferred increased",
"phys_cond_dStable" = "Physical condition stable",
"phys_cond_dIncreased" = "Physical condition increased",
"act_heavy_dStable" = "Ability for heavy activity stable",
"act_heavy_dIncreased" = "Ability for heavy activity increased",
"day_act_dStable"  = "Typical day activity stable",
"day_act_dIncreased" = "Typical day activity increased",
"h_act_light_dStable"  = "Hours for light activity stable",
"h_act_light_dIncreased"  = "Hours for light activity increased",
"sleep_enough_dStable" = "Enough sleep stable",
"sleep_enough_dIncreased"  = "Enough sleep increased",
"sleep_tired_dStable" = "Tired during day stable",
"sleep_tired_dIncreased" = "Tired during day increased",
"freq_calm_dStable" = "Frequency of feeling calm stable",
"freq_calm_dIncreased" =  "Frequency of feeling calm increase",
"life_qualgood" = "Quality of life good",
"life_qualvery_good" = "Quality of life very good",
"employmentTRUE" = "Full time employed"
)
```



```{r}
temp <-
  tidy_logit_men %>% 
  bind_rows(tidy_logit_post_menop_women) %>% 
  bind_rows(tidy_logit_pre_menop_women) %>% 
  dplyr::select(group, term, OR, p.value) %>% 
  rename(regressor = term) %>% 
  inner_join(bootstrap_Bca_CI,
             by =  c("regressor", "group")) %>% 
  filter(regressor != "(Intercept)") %>% 
  mutate(Bca_inf = exp(Bca_inf),
         Bca_sup = exp(Bca_sup),
         is_sig = p.value < 0.05) %>%
  mutate(
    regressor = plyr::revalue(regressor, regressor_values),
    regressor = ordered(regressor,
                        levels =  as.character(regressor_values)),
    regressor = fct_rev(regressor),
    group = case_when(group == "Pre_menopause_women" ~ "Pre-menopausal women",
                      group == "Post_menopause_women" ~ "Post-menopausal women",
                      TRUE ~ "Men"),
    group = ordered(group, levels = c(  "Pre-menopausal women",  "Post-menopausal women", "Men"  )
    )
  )

temp2 <-
  tidy_logit_men %>% 
  bind_rows(tidy_logit_post_menop_women) %>% 
  bind_rows(tidy_logit_pre_menop_women) %>% 
  dplyr::select(group, term, OR, p.value) %>% 
  rename(regressor = term) %>% 
  inner_join(bootstrap_Bca_CI_2,
             by =  c("regressor", "group")) %>% 
  filter(regressor != "(Intercept)") %>% 
  mutate(Bca_inf = exp(Bca_inf),
         Bca_sup = exp(Bca_sup),
         is_sig = p.value < 0.05) %>%
  mutate(
    regressor = plyr::revalue(regressor, regressor_values),
    regressor = ordered(regressor,
                        levels =  as.character(regressor_values)),
    regressor = fct_rev(regressor),
    group = case_when(group == "Pre_menopause_women" ~ "Pre-menopausal women",
                      group == "Post_menopause_women" ~ "Post-menopausal women",
                      TRUE ~ "Men"),
    group = ordered(group, levels = c(  "Pre-menopausal women",  "Post-menopausal women", "Men"  )
    )
  )
    

```

```{r}
bootstrap_Bca_CI <- temp
plotdata <- bootstrap_distrib %>% 
  mutate(regressor = plyr::revalue(regressor, regressor_values),
  regressor = ordered(regressor,
                  levels = as.character(regressor_values)),
  regressor = fct_rev(regressor),
  group = case_when(group == "Pre_menopause_women" ~ "Pre-menopausal women",
    group == "Post_menopause_women" ~ "Post-menopausal women",
    TRUE ~ "Men"),
  group = ordered(group, levels = c( "Men",  "Post-menopausal women", "Pre-menopausal women" ) )) %>% 
  mutate(OR = exp(coefficient))

bootstrap_Bca_CI_2 <- temp2

file <- "../results/exp_bootstrap_Bca_CI.csv"
temp <- bootstrap_Bca_CI %>% mutate_if(is.numeric, round, digits = 3) %>% dplyr::select(regressor,group,p.value,OR,Bca_inf,Bca_sup) %>% arrange(desc(regressor),group)
write.csv(temp ,file = file,row.names = FALSE)

```

#Small plot of filtered variables for main paper
```{r fig1, fig.height = 10, fig.width = 15}
#set the forest plot OR scale lims
orlimR <- 1000
orlimL <- 1/orlimR
pointrange2size <- 1.4
#Filter for those that are sig in some:
bootstrap_Bca_CI_filtered <- bootstrap_Bca_CI %>% group_by(regressor) %>% mutate(some_sig= any(is_sig)) %>% filter(some_sig == TRUE)
#Set values on axes limits to facilitate plotting
bootstrap_Bca_CI_filtered$Bca_sup[bootstrap_Bca_CI_filtered$Bca_sup > orlimR] <- orlimR
bootstrap_Bca_CI_filtered$Bca_sup[bootstrap_Bca_CI_filtered$Bca_sup == 0] <- orlimR
bootstrap_Bca_CI_filtered$Bca_inf[bootstrap_Bca_CI_filtered$Bca_inf < orlimL] <- orlimL

#Filter for those that are sig in some:
bootstrap_Bca_CI_filtered_2 <- bootstrap_Bca_CI_2 %>% group_by(regressor) %>% mutate(some_sig= any(is_sig)) %>% filter(some_sig == TRUE)
#Set values on axes limits to facilitate plotting
bootstrap_Bca_CI_filtered_2$Bca_sup[bootstrap_Bca_CI_filtered_2$Bca_sup > orlimR] <- orlimR
bootstrap_Bca_CI_filtered_2$Bca_sup[bootstrap_Bca_CI_filtered_2$Bca_sup == 0] <- orlimR
bootstrap_Bca_CI_filtered_2$Bca_inf[bootstrap_Bca_CI_filtered_2$Bca_inf < orlimL] <- orlimL


plotdata_filtered <- plotdata %>% filter(plotdata$regressor %in% bootstrap_Bca_CI_filtered$regressor) 


p  <- ggplot(aes(x = regressor, y = OR, color = group, fill = group),data = plotdata_filtered) +
  geom_hline(yintercept = 1 , color = "grey", linetype = "dotted",
             size = 1) +
  # geom_violin(alpha = 0.15, trim = TRUE, position = position_dodge(width = 0.8), size = 0.1) +
  geom_pointrange(data = bootstrap_Bca_CI_filtered,
                  aes(ymin=Bca_inf, ymax = Bca_sup, shape = is_sig, color = group, fill = group),
                  position = position_dodge(width = 0.7), size = 1, linetype = 1) +
  # geom_pointrange(data = bootstrap_Bca_CI_filtered_2,
  #                 aes(ymin=Bca_inf, ymax = Bca_sup, shape = is_sig, color = group, fill = group),
  #                 position = position_dodge(width = 0.7), size = pointrange2size) +
  # # geom_point(data = bootstrap_Bca_CI, 
  #            aes(shape = is_sig, fill = group),
  #            position = position_dodge(width = 0.8), size = 2) +
    scale_color_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                     limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
     scale_fill_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                     limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
 scale_shape_manual(values = c(1,16)) +
  scale_y_log10(limits=c(orlimL,orlimR)) +
  # scale_x_discrete(labels=parse(text=unique(bootstrap_Bca_CI$regressor)))
  # ylim(1/35, 35) +
  guides(shape = FALSE) +
  theme_classic() +
  # theme(legend.position = c(0.8,0.9),
  #       legend.title = element_blank(),
  #       legend.box = "vertical",
  #       legend.text = element_text(size = 20),
  #       plot.title =  element_text(size = 24,
  #                                 hjust = 0),
  #       panel.grid.minor.y = element_blank(),
  #       axis.line = element_line(colour="black"),
  #       axis.title.y = element_blank(),
  #       axis.title.x = element_text(size = 24),
  #       axis.text = element_text(size = 22),
  #       panel.grid.major.y = element_blank()) +
  coord_flip() +
  xlab("Robust standardized coefficient") +
  labs(title = "PREDICTORS OF WORSENED SELF-RATED HEALTH \nBETWEEN QUESTIONNAIRES",
       subtitle = "") +
   theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 14, angle = 30,hjust = 0.8),
        plot.title =  element_text(size = 16),
        plot.subtitle = element_text(size = 16,
                                     hjust = 0.5))

p

```

```{r}

p <- p +   labs(title = NULL,subtitle = NULL)
ggplot2::ggsave(filename = "../results/figures/exp_small_log_reg_results_b.pdf",
                plot= p,
# do not change these rather just scale the ready pdf later if you need.
       width = 35,
       height = 25,
       dpi = 600,
       units = "cm")

```


#Big plot of all variables for supplement
```{r fig2, fig.height = 40, fig.width = 15}

bootstrap_Bca_CI$Bca_sup[bootstrap_Bca_CI$Bca_sup > orlimR] <- orlimR
bootstrap_Bca_CI$Bca_sup[bootstrap_Bca_CI$Bca_sup == 0] <- orlimR
bootstrap_Bca_CI$Bca_inf[bootstrap_Bca_CI$Bca_inf < orlimL] <- orlimL

#Set values on axes limits to facilitate plotting
bootstrap_Bca_CI_2$Bca_sup[bootstrap_Bca_CI_2$Bca_sup > orlimR] <- orlimR
bootstrap_Bca_CI_2$Bca_sup[bootstrap_Bca_CI_2$Bca_sup == 0] <- orlimR
bootstrap_Bca_CI_2$Bca_inf[bootstrap_Bca_CI_2$Bca_inf < orlimL] <- orlimL


p2  <- ggplot(aes(x = regressor, y = OR, color = group, fill = group),data = plotdata) +
  geom_hline(yintercept = 1 , color = "grey", linetype = "dotted",
             size = 1) +
  # geom_violin(alpha = 0.15, trim = TRUE, position = position_dodge(width = 0.8), size = 0.1) +
  geom_pointrange(data = bootstrap_Bca_CI,
                  aes(ymin=Bca_inf, ymax = Bca_sup, shape = is_sig, color = group, fill = group),
                  position = position_dodge(width = 0.7), size = 1, linetype = 2) +
  geom_pointrange(data = bootstrap_Bca_CI_2,
                  aes(ymin=Bca_inf, ymax = Bca_sup, shape = is_sig, color = group, fill = group),
                  position = position_dodge(width = 0.7), size = pointrange2size) +
  # # geom_point(data = bootstrap_Bca_CI, 
  #            aes(shape = is_sig, fill = group),
  #            position = position_dodge(width = 0.8), size = 2) +
    scale_color_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                     limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
     scale_fill_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                     limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
 scale_shape_manual(values = c(1,16)) +
  scale_y_log10(limits=c(orlimL,orlimR)) +
  # scale_x_discrete(labels=parse(text=unique(bootstrap_Bca_CI$regressor)))
  # ylim(1/35, 35) +
  guides(shape = FALSE) +
  theme_classic() +
  # theme(legend.position = c(0.8,0.9),
  #       legend.title = element_blank(),
  #       legend.box = "vertical",
  #       legend.text = element_text(size = 20),
  #       plot.title =  element_text(size = 24,
  #                                 hjust = 0),
  #       panel.grid.minor.y = element_blank(),
  #       axis.line = element_line(colour="black"),
  #       axis.title.y = element_blank(),
  #       axis.title.x = element_text(size = 24),
  #       axis.text = element_text(size = 22),
  #       panel.grid.major.y = element_blank()) +
  coord_flip() +
  xlab("Robust standardized coefficient") +
  labs(title = "PREDICTORS OF WORSENED SELF-RATED HEALTH \nBETWEEN QUESTIONNAIRES",
       subtitle = "") +
   theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 14, angle = 30,hjust = 0.8),
        plot.title =  element_text(size = 16),
        plot.subtitle = element_text(size = 16,
                                     hjust = 0.5))

p2
```



```{r}
p2 <- p2 +   labs(title = NULL,subtitle = NULL)
ggplot2::ggsave(filename = "../results/figures/exp_big_log_reg_results_b.pdf",
                plot= p2,
       width = 35,
       height = 55,
       dpi = 600,
       units = "cm")

```


#Separate plots for individual variables

```{r}
fig.width=15
fig.height=13
#Load questionnaire data
load(file = "../data/final_data.rdata") 
final_data <- data

```

## Change in physical condition color
```{r}

pdata <- final_data %>% 
  dplyr::select(donor, group, health, questionnaire) %>% 
  drop_na(group) %>% 
  filter( group != "Women_pre_menop_no_mens") %>% 
  spread(key = questionnaire, value = health) %>% 
  filter(First != "NA" & Second != "NA") %>%  
  mutate(Difference = case_when(First < Second ~ "Improved",
                                First == Second ~ "Stable",
                                TRUE ~ "Worsened")) %>% 
  inner_join(regression_data, by = c("donor", "group")) %>% 
  mutate(group = case_when(group == "Pre_menopause_women" ~ "Pre-menopausal \n women",
                           group == "Post_menopause_women" ~ "Post-menopausal \n women",
                           TRUE ~ "Men"),
         group = ordered(group, levels = c(  "Men", "Post-menopausal \n women", "Pre-menopausal \n women") ))
 
p <- ggplot(aes(x= phys_cond_d , fill = group), data=pdata) +
  # geom_hline(yintercept = 15, color = "red", linetype = 3)
  geom_bar()+
  #geom_boxplot(outlier.alpha = 0) +
  #geom_beeswarm(alpha = 0.5, shape = 1) +
  # scale_y_log10() +
  facet_grid(group ~ Difference,scales="free_y") +
  scale_fill_manual(values = c( "#ff85a2",  "#de2d26","#00BFFF" ),
                    limits = c("Pre-menopausal \n women", "Post-menopausal \n women","Men" )) +
  theme_bw() +
  theme(legend.position = "none") +
  ggtitle("Evolution of self-rated health") +
  xlab("Change in physical condition") +
  ylab("Count") +
  geom_text(stat='count', aes(label=..count..),color="black", vjust=1)  
#scale_y_log10() 



ggplot2::ggsave(plot=p,filename = "../results/figures/exp_phys_cond_c.pdf",
       width = fig.width,
       height = fig.height,
       dpi = 600,
       units = "cm")

p
```




## Quality of life
```{r}

p <- ggplot(aes(x= life_qual), data=pdata) +
  # geom_hline(yintercept = 15, color = "red", linetype = 3)
  geom_bar(aes(fill=group))+
  #geom_boxplot(outlier.alpha = 0) +
  #geom_beeswarm(alpha = 0.5, shape = 1) +
  # scale_y_log10() +
  facet_grid(group ~ Difference,scales="free_y") +
  theme_bw() +
  theme(legend.position = "none") +
  ggtitle("Evolution of self-rated health")+
  xlab("Quality of life") +
  ylab("Count") +
  geom_text(stat='count', aes(label=..count..),color="black", vjust=1) +
  scale_fill_manual(values = c( "#ff85a2",  "#de2d26","#00BFFF" ),
                     limits = c("Pre-menopausal \n women", "Post-menopausal \n women","Men" ))

ggplot2::ggsave(plot=p,filename = "../results/figures/exp_life_qual_c.pdf",
       width = fig.width,
       height = fig.height,
       dpi = 600,
       units = "cm")

p
```


