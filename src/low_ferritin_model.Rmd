---
title: "Low ferritin model"
author: "Sofie Ekroos"
date: "19.7.2021"
output: github_document
bibliography: index.bib
---

Based on the original code written by Muriel Lobier and Mikko Arvas (https://github.com/FRCBS/iron_levels_of_blood_donors/blob/master/src/index.Rmd and https://github.com/FRCBS/changes_in_donor_health/blob/master/src/explorative_analysis.Rmd)

# Summary

This document includes all codes necessary to run the analysis of and produce the figures for the three Finnish Cohorts (FinDonor, FINRISK97, Health2000). The code allows the user to:

- describe the cohorts and compute the prevalence of iron deficiency
- identify co-variants of iron deficiency using multivariable linear regression 

```{r setup, , message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
# library(janitor)
library(tableone)
library(stargazer)
library(gridExtra)
library(cowplot)
library(broom)
library(GGally)
library(ggfortify)
# library(sjPlot)
library(knitr)
library(lubridate)
#library(HDInterval) !! package ‘HDIinterval’ is not available (for R version 3.6.3)!!!
library(car)
#library(relaimpo)
library(sfsmisc)
library(MASS)
# library(kableExtra)
#library(brms)
#library(rstan)
#library(rms)
#library(modelr)
#library(tidybayes)
library(ordinal)
library(sjmisc)
#library(sjlabelled)
# library(lazerhawk)
```


# Data loading and preparation

```{r , warning=FALSE}

load("../data/r02.fd.bd.all.rdata")

indiv_donations_data <- output

rm(output)
```


## Load Data


There are `r indiv_donations_data %>% distinct(donor) %>% nrow()` donors enrolled in the study. 

There are `r indiv_donations_data %>%  filter(!is.na(Ferritin) & !is.na(Hb_v) ) %>% distinct(donor) %>% nrow()` left once we remove donors that have no Ferritin or no Hb measurement for any donation event. 



```{r , warning=FALSE}
# Get sex for each donor
blood_data_summary <- indiv_donations_data %>% 
  group_by(donor) %>% 
  summarise(sex=first(gender)) 

# Get values for first study donation with the required measurements 
# donation (regardless of donation type)
# We remove events with no Ferritin and hb_v to be inline with from when 
# the nb of previous donations were counted.


blood_values_init <- indiv_donations_data %>% 
  filter(!is.na(Ferritin) & !is.na(Hb_v) ) %>% 
  group_by(donor) %>% 
  filter(date == min(date)) %>% 
  dplyr::select(age,TransferrinR, Ferritin,Hb_v,CRP,DaysToPreviousFB, MCV, donor) %>% 
  ungroup()


blood_data_summary <- blood_data_summary %>% 
  full_join(blood_values_init, by = "donor") 

# We now add the demographic data
load("../data/r02ds.donorData.rdata")
dons <- output
rm(output)


blood_data_summary <- dons %>%
  inner_join(blood_data_summary, by = "donor") %>%
  mutate(all_study_FB_donation_count = NonFinnDonorDonationCount_FB + YesFinnDonorDonationCount_FB) 
```


## Demographic group specification and assignment

There are `r blood_data_summary %>% filter(sex == "Women" & is.na(QR79)) %>%  nrow()` women with no  answer to the question regarding their menstrual status. Of these, `r blood_data_summary %>% filter(sex == "Women" & is.na(QR79) & age > 65) %>%  nrow()` are older than 65. We impute these to  no period so they can be included in the post-menopausal women. Other women are all under 55, thus their menstrual status cannot be ascertained. 


```{r}
older_donors <- filter(blood_data_summary, 
                       sex == "Women" & is.na(QR79) & age > 55)$donor

blood_data_summary <- blood_data_summary %>% 
  mutate(QR79 = ifelse(donor %in% older_donors, "no_period", as.character(QR79))) 
```


Female donors with no menstruation response after imputation are removed: `r blood_data_summary %>% filter(sex == "Women" & is.na(QR79)) %>% nrow()` donors.


```{r}
nb_women_no_mesntruation_response <- blood_data_summary %>% filter(sex == "Women" & is.na(QR79)) %>% nrow()


# remove female donors with no menstruation response
blood_data_summary_final <- blood_data_summary %>% 
  mutate(mens_ok = case_when(
    sex == "Men" ~ "Men", 
    sex == "Women" & !is.na(QR79)  ~ "Women",
    TRUE ~ "NA")) %>% 
  filter(mens_ok != "NA") 

# We define the women's groups: 
n_women_removed <- blood_data_summary_final %>% 
  mutate(group = case_when(
    sex == "Men" ~ "Men", 
    sex == "Women" & (QR79 == "no_period" & age > 45) ~ "Post_menopause_women",
    sex == "Women" & (QR79 == "no_period" & age <= 45) ~ "Women_pre_menop_no_mens",
    sex == "Women" & (QR79 == "irregular_period" | QR79 == "regular_period") ~ "Pre_menopause_women",
    TRUE ~ "NA")) %>% 
  group_by(group) %>% 
  filter(group ==  "Women_pre_menop_no_mens") %>% 
  nrow()

```

We now define the following groups:

+ pre-menopausal: regular or irregular menstruation reported
+ post-menopausal: no menstruation reported and age equal to superior to 45
+ donors younger than 45 and no reported menstruation are excluded (`r n_women_removed` donors)



```{r}
# We define the women's groups: 
blood_data_summary_final <- blood_data_summary_final %>% 
  mutate(group = case_when(
    sex == "Men" ~ "Men", 
    sex == "Women" & (QR79 == "no_period" & age > 45) ~ "Post_menopause_women",
    sex == "Women" & (QR79 == "no_period" & age <= 45) ~ "Women_pre_menop_no_mens",
    sex == "Women" & (QR79 == "irregular_period" | QR79 == "regular_period") ~ "Pre_menopause_women",
    TRUE ~ "NA")) %>% 
  filter(group != "Women_pre_menop_no_mens" & group != "NA") %>% 
  droplevels() %>% 
  mutate(group = ordered(group, levels =  c("Pre_menopause_women", "Post_menopause_women", "Men"))) 
```



## Remove donors with missing data

### Blood measures and donor demographics

We remove donors for which we do not have:

* CRP or sTfR: `r blood_data_summary_final %>% filter(is.na(CRP) | is.na(TransferrinR)) %>% nrow()` donors

```{r}
nb_NA_removed <- blood_data_summary_final %>%
  filter(is.na(TransferrinR) | is.na(CRP) ) %>% 
  nrow()

blood_data_summary_final <- blood_data_summary_final %>% 
  drop_na(TransferrinR, CRP) 

```


### Donation history

We remove `r blood_data_summary_final %>% filter(is.na(DaysToPreviousFB)) %>% nrow()` donors who have not donated previously (They are missing the Nb of days since last FB donation variable)

```{r}
new_donors_data <- blood_data_summary_final %>% 
  filter(is.na(DaysToPreviousFB)) %>% 
    mutate(group = case_when(group == "Pre_menopause_women" ~ "Pre-menopausal women",
                   group == "Post_menopause_women" ~ "Post-menopausal women",
                   group == "Men" ~ "Men" ,
                   TRUE~ "NA"),
         group = ordered(group)) 

blood_data_summary_final <- blood_data_summary_final %>% 
  drop_na(DaysToPreviousFB)
```

### BMI

We remove `r blood_data_summary_final %>% filter(is.na(BMI)) %>% nrow()` donors for whom we do not have the BMI data:

```{r}
nb_removed_questionnaire <- nb_women_no_mesntruation_response +
                            blood_data_summary_final %>% filter(is.na(BMI)) %>% nrow() 

blood_data_summary_final <- blood_data_summary_final %>% 
  filter(!is.na(BMI))
```

### Smoking

We remove `r blood_data_summary_final %>% filter(is.na(QR54)) %>% nrow()` donors  who  did not answer the smoking question:

```{r}
nb_removed_questionnaire <- nb_removed_questionnaire +
                            blood_data_summary_final %>% filter(is.na(QR54)) %>% nrow() 

blood_data_summary_final <- blood_data_summary_final %>% 
  filter(!is.na(QR54))
```

### Pregnancy

We remove `r blood_data_summary_final %>% filter((group != "Men" & is.na(QR83)))%>% nrow()` female donors who did not answer the pregnancy question: 

```{r}
nb_removed_questionnaire <- nb_removed_questionnaire +
                            blood_data_summary_final %>% filter((group != "Men" & is.na(QR83))) %>% nrow 

blood_data_summary_final <- blood_data_summary_final %>% 
  filter(!(group != "Men" & is.na(QR83)))
```

### Iron supplementation 

We remove `r blood_data_summary_final %>% mutate(iron_comp_c = ifelse(iron_supp == FALSE, 0, iron_comp_c )) %>%  filter(is.na(iron_comp_c)) %>% nrow()` donors that did not answer properly to both questions if applicable.

For the modelling, we impute a 0 (no supplementation) to iron_comp_c when the donor reports not being offered iron supplementation.

```{r}
nb_removed_questionnaire <- nb_removed_questionnaire +
                            blood_data_summary_final %>% 
                              mutate(iron_comp_c = ifelse(iron_supp == FALSE, 0, iron_comp_c )) %>% 
                              filter(is.na(iron_comp_c)) %>% 
                              nrow() 

blood_data_summary_final <- blood_data_summary_final %>% 
  mutate(iron_comp_c = ifelse(iron_supp == FALSE, 0, iron_comp_c )) %>% 
  filter(!is.na(iron_comp_c))
```

### Food and drink intake

* QR40 how often do you eat meat

```{r message=FALSE, warning=FALSE}

donors_to_remove <- blood_data_summary_final %>% 
  dplyr::select(donor, group, QR40) %>% 
  gather(key= question, value = answer, -donor,-group) %>% 
  filter(is.na(answer)) %>% 
  dplyr::select(group, donor) %>% 
  distinct(donor, group) 


blood_data_summary_final <- blood_data_summary_final %>% 
  filter(!donor %in% donors_to_remove$donor) 

nb_removed_questionnaire <- nb_removed_questionnaire +
                            donors_to_remove %>% nrow()


```

### Total number of donors removed for missing questionnaire answers

The total number of donors removed because of missing answers in the questionnaire is `r nb_removed_questionnaire`

## Remove donors with extreme physiological measures

As decided previously, we remove data according the following criteria:

* BMI > 50
* CRP > 30
* Ferritin > 400 

This amounts to `r blood_data_summary_final %>% filter(BMI >= 50 | CRP >= 30 | Ferritin >= 400) %>% nrow()` donors that are removed. 


```{r}
 blood_data_summary_final <- blood_data_summary_final %>% 
   filter(BMI < 50 & CRP < 30 & Ferritin < 400)
```

## Final group N

```{r}
blood_data_summary_final %>% 
   mutate(group = dplyr::recode(group, Pre_menopause_women = "Pre-menopausal women",
         Post_menopause_women = "Post-menopausal women")) %>% 
  group_by(group) %>% 
  summarise ( N = n()) %>% 
  kable() 
 
```


## Recoding of variables

```{r}

# We keep only the variables that are used in the analysis

blood_data_summary_final <- blood_data_summary_final %>% 
  dplyr::select(donor,group, sex, age,TwoYearsFromStartCount_FB,DaysToPreviousFB, Hb_v,
       Ferritin, CRP, TransferrinR, MCV, DaysToPreviousFB, QR40, iron_comp_c, BMI, QR83, iron_supp, QR54) %>% 
  rename(red_meat = QR40,
         pregnancy = QR83) %>% 
    mutate(smoking = ifelse(QR54 == "no", "no", "yes"),
         smoking = ordered(smoking, levels = c( "no",  "yes")),
         pregnancy = ordered(pregnancy, levels = c( "no",  "yes"))) %>% 
  dplyr::select(-QR54)


```

We recode the following variables:

* Smoking
* Pregnancy

We use a linear scale from 1 to 4 for red meat consumption and mapped the 6 possible response the 4 codes. 

* red meat:
    * "never" ~ 1,
    * "less_than_once_weekly" ~ 2,
    * "1.3_week" or "4.6_week"~ 3,
    * "daily" or "several_daily" ~ 4,

* Smoking:
    * "no" ~"no"
    * "sometimes" or "daily"  ~ "yes"
   
* QR83: have you given birth ?

```{r}
# Recode food and non-alcoholic beverages
food <- blood_data_summary_final %>% 
  dplyr::select(donor,red_meat) %>% 
  gather(key = key, value =  value, -donor) %>% 
  mutate(linear_value = case_when(value == "never" ~ 1,
    value == "less_than_once_weekly" ~ 2,
    value %in% c("1.3_week" , "4.6_week") ~ 3,
    TRUE   ~ 4 )) %>% # "daily" | "several_daily"
  dplyr::select(-value) %>% 
  mutate(key = paste(key, "n", sep = "_")) %>% 
  spread(key = key, value = linear_value)

blood_data_summary_final <- blood_data_summary_final %>% 
  full_join(food, by = "donor") 

```

# Results - Regression analyses

## Regressions on sTfR and ferritin  

We analyzed the data with multiple linear regression. We first ran Ordinary Least Square (OLS) regressions and their diagnostics. If the diagnostics identified problematic observations (e.g., outliers, influential observations), we also ran robust regression regressions [@yu2017robust]. Robust regression is based on less assumptions than OLS regression and is less sensitive to influential observations. It  gives more accurate estimates of regression coefficients in the presence of problematic observations. Using robust regression leads to a more principled approach to regression analysis and avoids potential confounds introduced by selective removal of influential observations. As the rlm command from the MASS package does not compute directly the *t* and *p* values, we used the f.robftest function from the sfsmisc package. Practical examples of using robust regression can be found in the literature [@davison2017platelet].  


In addition, we used relative importance analysis to estimate the average proportion of variance in the outcome variable explained by each co-variate [@Groemping2006]. Relative iportance was computed using the pmvd method which assigns 0 to the relative importance of a regressor if it is non significant in the complete model. .

The regressors were entered as follows in the regression models for sTfR and ferritin:

* Continuous variables were entered as continuous predictors
    * age, number of donations in last two years, nb of days since last donation, CRP, BMI
  
* Binary variables were entered as categorical (but coded as numerical for relative importance):
    * Smoking, pregnancy
  
* Ordinal variables were coded on a linear scale and entered as continuous [(Reference)](https://www3.nd.edu/~rwilliam/stats3/OrdinalIndependent.pdf)
    * Iron supplementation 
    * All dietary intake
  
We compute both coefficients and standardized coefficients (with all dependent and independent variables standardized) for robust regression and only coefficients for OLS regression. We present robust coefficients and their bootstrapped BCa 95% confidence intervals in Table 1 (ferritin) and  Table 2 (sTfR), robust standardized coefficients, their bootstrapped distribution and BCa 95% confidence intervals in Figure 2.A and non-standardized OLS regression coefficients in Supplementary Table 1 (Ferritin) and 2 (sTfR). 

## Pre-processing

### Rename and transform

```{r}
blood_data_summary_reg <- blood_data_summary_final %>% 
    rename(don_ct = TwoYearsFromStartCount_FB,
            last_don = DaysToPreviousFB,
            iron = iron_comp_c) %>% 
     mutate(don_ct_2 = don_ct^2,
            log_ferr = log(Ferritin),
            log_last_don = log(last_don)/log(2),
            log_CRP = log(CRP),
            log_sTfR = log(TransferrinR)) 
```

Data transformations:

* Log transformed variables: 
    * Ferritin
    * sTfR
    * CRP 
  
* Age is divided by 5 to simplify coeff interpretation
* Number of days before donation is transformed as $log\_last\_don = log(last\_don)/log(2)$ to help with the interpretation of coefficients. 
    * An increase in one of the transformed variable is equivalent to a doubling of the number of days since last donation.

* Standardization:
    * Standardized coefficients: 
        * All dependent and independent variables were standardized
      
    * Coefficients:
        * All dependent variables entered as continuous varaibles are centered but not scaled. 

## Pre-menopausal women
### Data pre-processing

We center all variables entered as continuous.

```{r}
# Center variables

test_data_std <- blood_data_summary_reg %>% 
  filter(group == "Pre_menopause_women") %>% 
  dplyr::select(donor ,red_meat_n) %>% 
  gather(key = key, value = value, -donor) %>% 
  group_by(key) %>% 
  mutate(value = scale(value, scale = FALSE)[,1]) %>% 
  spread(key = key, value = value)
  
test_data_std <- blood_data_summary_reg %>% 
  filter(group == "Pre_menopause_women") %>% 
  dplyr::select(donor, log_ferr, TransferrinR, age, log_CRP, BMI, don_ct,log_last_don,
                smoking, pregnancy, iron, log_sTfR) %>%
  mutate(age = age / 5, 
         age = scale(age, scale = FALSE)[,1],
         log_CRP = scale(log_CRP, scale = FALSE)[,1],
         don_ct = scale(don_ct, scale = FALSE)[,1],
         log_last_don = scale(log_last_don, scale = FALSE)[,1],
         BMI = scale(BMI, scale = FALSE)[,1],
         iron = scale(iron, scale = FALSE)[,1],
         don_ct_2 = don_ct^2) %>% 
  full_join(test_data_std, by = "donor")  %>% 
  dplyr::select(-donor)

```


### Mutiple regression - ferritin as outcome

#### Correlograms

```{r}

ggpairs(test_data_std, 
        columns = c("log_ferr", "age", "log_CRP",  "don_ct", "don_ct_2",
                    "log_last_don"),
         lower = list(continuous = wrap("points", alpha = 0.3,size=0.1),
                      combo = wrap("facethist", binwidth = 0.5)),
        progress = FALSE)
```

```{r}

ggpairs(test_data_std, 
        columns = c("log_ferr", "pregnancy",  "red_meat_n", "smoking", "iron", "BMI"),
         lower = list(continuous = wrap("points", alpha = 0.3,size=0.1),
                      combo = wrap("facethist", binwidth = 0.5)),
        progress = FALSE)
```


```{r}

# ggpairs(test_data_std, 
#         columns = c("log_ferr", "coffee_n", "tea_n", "beer_n", "wine_n", "liquor_n"),
#          lower = list(continuous = wrap("points", alpha = 0.3,size=0.1),
#                       combo = wrap("facethist", binwidth = 0.5)),
#         progress = FALSE)

```

<!-- #### OLS  -->

<!-- ```{r } -->

<!-- # lm7_pre_menop_std <-lm(log_ferr ~ age + BMI + log_CRP + smoking + pregnancy  + don_ct + don_ct_2 +  -->
<!-- #                          log_last_don + iron + red_meat_n + vegetables_n + fruit_berries_n + milk_n + -->
<!-- #                          fruit_juices_n +  coffee_n +  tea_n + beer_n + wine_n + liquor_n, test_data_std ) -->

<!-- ``` -->



### logistical regression 
  
```{r setup, include=FALSE}
Sys.setlocale("LC_MESSAGES", 'en_GB.UTF-8')
Sys.setenv(LANG = "en_US.UTF-8")
# echo "rmarkdown::render('explorative_analysis.Rmd', clean=TRUE,output_format='html_document',output_file='../results/explorative_analysis.html')" | R --slave
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(epiDisplay)
library(tidyverse)
library(safeBinaryRegression)
library(epitools)
library(ez)
library(lubridate)
library(ggbeeswarm)
library(tidymodels)
library(broom)
library(GGally)
library(ggfortify)
library(car)
library(boot)
library(tableone)
library(kableExtra)

#https://stats.stackexchange.com/questions/11109/how-to-deal-with-perfect-separation-in-logistic-regression
#https://stats.stackexchange.com/questions/45803/logistic-regression-in-r-resulted-in-perfect-separation-hauck-donner-phenomenon
```
  
  
  
# Bootstraps
https://data.princeton.edu/wws509/r/c3s1
https://stats.stackexchange.com/questions/304833/how-to-calculate-odds-ratio-and-95-confidence-interval-for-logistic-regression
https://www.andrewheiss.com/blog/2016/04/25/convert-logistic-regression-standard-errors-to-odds-ratios-with-r/

```{r}
detach("package:safeBinaryRegression", unload=TRUE)
#safeBinaryRegression messes up booting
```

## Define auxiliarry functions for bootstrapping
```{r}

# https://www.painblogr.org/2017-10-18-purrring-through-bootstraps.html


get_coefficients <- function(data, boot_ind){
  fit <- glm (health_outcome~.,
              data[boot_ind,],
              family = "binomial")
#  print(names(coef(fit)))
  return(coef(fit))
}



compute_Bca_CI <-function(fit_boot,conf = 0.95){
  cat("compute_Bca_CI with conf: ",conf,"\n")
  Bca_inf = rep(0, length(fit_boot$t0))
  Bca_sup = rep(0, length(fit_boot$t0))
  for (i_regressor in 1:length(fit_boot$t0)){
    CI <- boot.ci(fit_boot, type = "bca", index=i_regressor,conf = conf)
    Bca_inf[i_regressor] <- CI$bca[4]
    Bca_sup[i_regressor] <- CI$bca[5]
  }
  return(tibble(Bca_inf,Bca_sup, regressor = names(fit_boot$t0)) %>% 
           filter(regressor != "(Intercept)"))
}


get_bootstrap <- function(data, nb_boot){
 cat(nrow(data),"get_bootstrap 1\n")
 

    fit_boot <- boot(data, statistic= get_coefficients, R = nb_boot)

 cat(nrow(data),"get_bootstrap 2\n")
  fit_boot_distrib <- as.tibble(fit_boot$t)  
  names(fit_boot_distrib) <- names(fit_boot$t0)

  fit_boot_Bca <- compute_Bca_CI(fit_boot)
  fit_boot_Bca_2 <- compute_Bca_CI(fit_boot,conf=0.80)
  cat(nrow(data),"get_bootstrap 3\n")
  return(list(fit_boot_distrib,fit_boot_Bca,fit_boot_Bca_2))
}


```

## Run bootstrapping
```{r}
# Error in t.star[r, ] <- res[[r]] : 
#   number of items to replace is not a multiple of replacement length
#can sometimes be fixed by just adding bootstrap, but sometimes requires dropping out a variable


get_bootstrap_coeffs <- function(regression_data, current_group, nb_boot )
{

  ## preprocess and standardize data
  
    test_data_std <- regression_data %>% 
      filter(group == current_group) %>% 
      dplyr::select(donor, age, starting_weight, BMI_diff,
                    log_Ferritin_beginning, Hb_beginning, 
                    donation_frequency) %>% 
      gather(key = key, value = value, -donor) %>% 
      group_by(key) %>% 
      mutate(value_scale = scale(value, scale = FALSE)[,1]) %>% 
      dplyr::select(-value) %>% 
      spread(key = key, value = value_scale) 
     
    if (current_group == "Men") {
      test_data_std <- inner_join(test_data_std,regression_data %>% 
                                    dplyr::select(donor, health_outcome, health_very_good, health_excellent,
                                                #  sleep_night_d, ##Error in t.star[r, ] <- res[[r]] :
                                                  cholesterol_d,
                                                  blood_sugar_d,
                                                  HBP_d,
                                                  low_hb_hist_d,
                                                  iron_supp_d,
                                                  freq_calm_d,
                                                  freq_red_meat_d,
                                                  freq_fruits_d,
                                                  freq_juices_d,
                                                  freq_wholem_d,
                                                  freq_milk_d,
                                                  freq_cof_d,
                                                  freq_tea_d,
                                                  phys_cond_d,
                                                  act_heavy_d,
                                                  sleep_enough_d,
                                                  day_act_d,
                                                  h_act_light_d,
                                                  vita_multi_d,
                                                  #vita_iron_d, #Error in t.star[r, ] <- res[[r]]
                                                  sleep_tired_d,
                                                  anti_inf_d,
                                                  phys_inf_d,
                                                  #  ment_inf_d,
                                                  freq_alc_d,
                                                  life_qual,
                                                  employment
                                                #  education # Error in t.star[r, ] <- res[[r]] : 
                                                # smoking_behavior #Error in t.star[r, ] <- res[[r]] :
                                                  
                                    ),
                                  by = "donor") %>% 
        dplyr::select(-donor) 
    }
    
    if (current_group == "Pre_menopause_women") {
      test_data_std <- inner_join(test_data_std,regression_data %>% 
                                    dplyr::select(donor, health_outcome, health_very_good, health_excellent,
                                                #  sleep_night_d, #Error in t.star[r, ] <- res[[r]] :
                                                  cholesterol_d,
                                                  blood_sugar_d,
                                                  HBP_d,
                                                  low_hb_hist_d,
                                                  iron_supp_d,
                                                  freq_calm_d,
                                                  freq_red_meat_d,
                                                  freq_fruits_d,
                                                  freq_juices_d,
                                                  freq_wholem_d,
                                                  freq_milk_d,
                                                  freq_cof_d,
                                                  freq_tea_d,
                                                  phys_cond_d,
                                                  act_heavy_d,
                                                  sleep_enough_d,
                                                  day_act_d,
                                                  h_act_light_d,
                                                  vita_multi_d,
                                                  #vita_iron_d, #Error in t.star[r, ] <- res[[r]]
                                                  sleep_tired_d,
                                                  anti_inf_d,
                                                  phys_inf_d,
                                                  # ment_inf_d,
                                                  freq_alc_d,
                                                  life_qual,
                                                  employment
                                                #  education #Error in t.star[r, ] <- res[[r]] : 
                                               #   smoking_behavior # Error in t.star[r, ] <- res[[r]] : 
                                                  
                                    ),
                                  by = "donor") %>% 
        dplyr::select(-donor) 
    }
    
      if (current_group == "Post_menopause_women") {
      test_data_std <- inner_join(test_data_std,regression_data %>% 
                                    dplyr::select(donor, health_outcome, health_very_good, health_excellent,
                                                #  sleep_night_d, #Error in t.star[r, ] <- res[[r]] :
                                                 cholesterol_d,
                                                 blood_sugar_d,
                                                  HBP_d,
                                                  low_hb_hist_d,
                                                  iron_supp_d,
                                                  freq_calm_d,
                                                  freq_red_meat_d,
                                                  freq_fruits_d,
                                                  freq_juices_d,
                                                  freq_wholem_d,
                                                  freq_milk_d,
                                                  freq_cof_d,
                                                  freq_tea_d,
                                                  phys_cond_d,
                                                  act_heavy_d,
                                                  sleep_enough_d,
                                                  day_act_d,
                                                  h_act_light_d,
                                                  vita_multi_d,
                                                  #vita_iron_d #Error in t.star[r, ] <- res[[r]]
                                                  sleep_tired_d,
                                                  anti_inf_d,
                                                  phys_inf_d,
                                                  # ment_inf_d # Error in t.star[r, ] <- res[[r]]
                                                  freq_alc_d,
                                                  life_qual, # Error in bca.ci(boot.out, conf, index[1L], L = L, t = t.o, t0 = t0.o,  : estimated adjustment 'w' is infinite -> works if 10k boots.
                                                  employment
                                                #  education # Error in bca.ci(boot.out, conf, index[1L], L = L, t = t.o, t0 = t0.o,  :
                                                #  smoking_behavior # Error in t.star[r, ] <- res[[r]]
                                                  
                                    ),
                                  by = "donor") %>% 
        dplyr::select(-donor) 
    }
  cat(nrow(test_data_std),current_group,"get_bootstrap_coeffs 1\n")
  result <- test_data_std %>% 
  get_bootstrap(nb_boot = nb_boot)

  cat(nrow(test_data_std),current_group,"get_bootstrap_coeffs 2\n")
  bootstrap_distrib <- result[[1]] %>% 
    gather(key = regressor, value = coefficient) %>% 
    filter(regressor != "(Intercept)") %>% 
    mutate(group = current_group)
      cat(nrow(test_data_std),current_group,"get_bootstrap_coeffs 3\n")
  Bca_CI  <- result[[2]] %>% mutate(group = current_group)
  Bca_CI_2  <- result[[3]] %>% mutate(group = current_group)
  cat(nrow(test_data_std),current_group,"get_bootstrap_coeffs 4\n")
  return(list(bootstrap_distrib,Bca_CI,Bca_CI_2))
}




#get_from_file_ferr = TRUE



set.seed(125)
#group_str = "Pre_menopause_women"

for(group_str in c("Pre_menopause_women","Men","Post_menopause_women")){
#  for(group_str in c("Pre_menopause_women")) {
#for(group_str in c("Post_menopause_women","Pre_menopause_women")){
  output_file_distrib = paste0("../results/bootstraps/exp_coeff_boot_distrib_seed_125_ctr_strata_final_",group_str,".rdata")
  output_file_Bca = paste0("../results/bootstraps/exp_coeff_boot_Bca_seed_125_ctr_strata_final_",group_str,".rdata")
  output_file_Bca_2 = paste0("../results/bootstraps/exp_coeff_boot_Bca_2_seed_125_ctr_strata_final_",group_str,".rdata")
  get_from_file_ferr <- all(file.exists(output_file_distrib),file.exists(output_file_Bca),file.exists(output_file_Bca_2) )
  if (get_from_file_ferr){
    cat("Loading boots from file for group ",group_str,"\n")
    stuff <- list()
    load(file=output_file_distrib)
    load(file=output_file_Bca)
    load(file=output_file_Bca_2)
    stuff[[1]] <- temp1  
    stuff[[2]] <- temp2
    stuff[[3]] <- temp3
  }else {
    stuff <- get_bootstrap_coeffs(regression_data, group_str, nb_boot = 10000)
    #         stuff <- get_bootstrap_coeffs(regression_data, group_str, nb_boot = 1000)
    temp1 <- stuff[[1]] 
    temp2 <- stuff[[2]] 
    temp3 <- stuff[[3]] 
    save(temp1,file=output_file_distrib) 
    save(temp2,file=output_file_Bca)
    save(temp3,file=output_file_Bca_2)
  }
  
  if(!exists("bootstrap_distrib")){
    cat("initializing bootstrap_distrib, bootstrap_Bca_CI_2 & bootstrap_Bca_CI\n")

    bootstrap_distrib <- stuff[[1]]
    cat("nrow(bootstrap_distrib)",nrow(bootstrap_distrib),"\n")
    bootstrap_Bca_CI <- stuff[[2]]
    cat("nrow(bootstrap_Bca_CI)",nrow(bootstrap_Bca_CI),"\n")
    bootstrap_Bca_CI_2 <- stuff[[3]]
    cat("nrow(bootstrap_Bca_CI_2)",nrow(bootstrap_Bca_CI_2),"\n")
  }else
  {
    cat("bootstrap_distrib & bootstrap_Bca_CI already exist\n")
    bootstrap_distrib<-bind_rows(bootstrap_distrib, stuff[[1]])
    bootstrap_Bca_CI<-bind_rows(bootstrap_Bca_CI, stuff[[2]])
    bootstrap_Bca_CI_2<-bind_rows(bootstrap_Bca_CI_2, stuff[[3]])
  }
  
}


```

```{r}
bootstrap_Bca_CI %>%  group_by(group) %>% count()

```

# Forest plots

```{r}
# "\U0394 BMI"

regressor_values <- c(
 "age" = "Age",
   "BMI_diff" = "BMI difference",
   "donation_frequency" = "Donation frequency",
   "Hb_beginning" = "Initial Hemoglobin",
   "log_Ferritin_beginning" ="Initial Ferritin",
   "starting_weight" ="Initial weight",
   "health_very_good" ="Initial health rating \n Very good vs Satisfactory/Good",
    "health_excellent" = "Initial health rating \n Excellent vs Satisfactory/Good",
 
 
 "cholesterol_dTRUE" = "Elevated cholesterol detected",
"blood_sugar_dTRUE" = "Elevated blood sugar detected", 
"HBP_dTRUE" = "High blood pressure detected",
"low_hb_hist_dTRUE" = "Low haemoglobin detected",
"iron_supp_dStable" = "FRCBS iron supplementation stable", 
"iron_supp_dIncreased" = "FRCBS iron supplementation increased",
"vita_multi_dStable" = "Frequency multivitamine stable",
"vita_multi_dIncreased" = "Frequency multivitamine increased",
#"vita_iron_dStable" = "Frequency iron supplements stable",
#"vita_iron_dIncreased" = "Frequency iron supplements increased",
"anti_inf_dStable" = "Frequency of anti-inflammatory stable",
"anti_inf_dIncreased" = "Frequency of anti-inflammatory increased",
"freq_red_meat_dStable" = "Frequency of red meat stable",
"freq_red_meat_dIncreased" = "Frequency of red meat increased",
"freq_fruits_dStable" = "Frequency of fruits stable",
"freq_fruits_dIncreased" = "Frequency of fruits increased",
"freq_juices_dStable" = "Frequency of juices stable",
"freq_juices_dIncreased" = "Frequency of juices increased",
"freq_wholem_dStable" = "Frequency of whole milk stable",
"freq_wholem_dIncreased" = "Frequency of whole milk increased",
"freq_milk_dStable" = "Frequency of milk stable",
"freq_milk_dIncreased" = "Frequency of milk increased",
"freq_cof_dStable" = "Frequency of coffee stable",
"freq_cof_dIncreased"  = "Frequency of coffee increased",
"freq_tea_dStable" = "Frequency of tea stable",
"freq_tea_dIncreased" = "Frequency of tea increased",
"freq_alc_dStable" = "Frequency of alcohol stable",
"freq_alc_dIncreased" = "Frequency of alcohol increased",
"phys_inf_dStable" = "Physical symptoms inferred stable",
"phys_inf_dIncreased" = "Physical symptoms inferred increased",
"phys_cond_dStable" = "Physical condition stable",
"phys_cond_dIncreased" = "Physical condition increased",
"act_heavy_dStable" = "Ability for heavy activity stable",
"act_heavy_dIncreased" = "Ability for heavy activity increased",
"day_act_dStable"  = "Typical day activity stable",
"day_act_dIncreased" = "Typical day activity increased",
"h_act_light_dStable"  = "Hours for light activity stable",
"h_act_light_dIncreased"  = "Hours for light activity increased",
"sleep_enough_dStable" = "Enough sleep stable",
"sleep_enough_dIncreased"  = "Enough sleep increased",
"sleep_tired_dStable" = "Tired during day stable",
"sleep_tired_dIncreased" = "Tired during day increased",
"freq_calm_dStable" = "Frequency of feeling calm stable",
"freq_calm_dIncreased" =  "Frequency of feeling calm increase",
"life_qualgood" = "Quality of life good",
"life_qualvery_good" = "Quality of life very good",
"employmentTRUE" = "Full time employed"
)
```



```{r}
temp <-
  tidy_logit_men %>% 
  bind_rows(tidy_logit_post_menop_women) %>% 
  bind_rows(tidy_logit_pre_menop_women) %>% 
  dplyr::select(group, term, OR, p.value) %>% 
  rename(regressor = term) %>% 
  inner_join(bootstrap_Bca_CI,
             by =  c("regressor", "group")) %>% 
  filter(regressor != "(Intercept)") %>% 
  mutate(Bca_inf = exp(Bca_inf),
         Bca_sup = exp(Bca_sup),
         is_sig = p.value < 0.05) %>%
  mutate(
    regressor = plyr::revalue(regressor, regressor_values),
    regressor = ordered(regressor,
                        levels =  as.character(regressor_values)),
    regressor = fct_rev(regressor),
    group = case_when(group == "Pre_menopause_women" ~ "Pre-menopausal women",
                      group == "Post_menopause_women" ~ "Post-menopausal women",
                      TRUE ~ "Men"),
    group = ordered(group, levels = c(  "Pre-menopausal women",  "Post-menopausal women", "Men"  )
    )
  )

temp2 <-
  tidy_logit_men %>% 
  bind_rows(tidy_logit_post_menop_women) %>% 
  bind_rows(tidy_logit_pre_menop_women) %>% 
  dplyr::select(group, term, OR, p.value) %>% 
  rename(regressor = term) %>% 
  inner_join(bootstrap_Bca_CI_2,
             by =  c("regressor", "group")) %>% 
  filter(regressor != "(Intercept)") %>% 
  mutate(Bca_inf = exp(Bca_inf),
         Bca_sup = exp(Bca_sup),
         is_sig = p.value < 0.05) %>%
  mutate(
    regressor = plyr::revalue(regressor, regressor_values),
    regressor = ordered(regressor,
                        levels =  as.character(regressor_values)),
    regressor = fct_rev(regressor),
    group = case_when(group == "Pre_menopause_women" ~ "Pre-menopausal women",
                      group == "Post_menopause_women" ~ "Post-menopausal women",
                      TRUE ~ "Men"),
    group = ordered(group, levels = c(  "Pre-menopausal women",  "Post-menopausal women", "Men"  )
    )
  )
    

```

```{r}
bootstrap_Bca_CI <- temp
plotdata <- bootstrap_distrib %>% 
  mutate(regressor = plyr::revalue(regressor, regressor_values),
  regressor = ordered(regressor,
                  levels = as.character(regressor_values)),
  regressor = fct_rev(regressor),
  group = case_when(group == "Pre_menopause_women" ~ "Pre-menopausal women",
    group == "Post_menopause_women" ~ "Post-menopausal women",
    TRUE ~ "Men"),
  group = ordered(group, levels = c( "Men",  "Post-menopausal women", "Pre-menopausal women" ) )) %>% 
  mutate(OR = exp(coefficient))

bootstrap_Bca_CI_2 <- temp2

file <- "../results/exp_bootstrap_Bca_CI.csv"
temp <- bootstrap_Bca_CI %>% mutate_if(is.numeric, round, digits = 3) %>% dplyr::select(regressor,group,p.value,OR,Bca_inf,Bca_sup) %>% arrange(desc(regressor),group)
write.csv(temp ,file = file,row.names = FALSE)

```

#Small plot of filtered variables for main paper
```{r fig1, fig.height = 10, fig.width = 15}
#set the forest plot OR scale lims
orlimR <- 1000
orlimL <- 1/orlimR
pointrange2size <- 1.4
#Filter for those that are sig in some:
bootstrap_Bca_CI_filtered <- bootstrap_Bca_CI %>% group_by(regressor) %>% mutate(some_sig= any(is_sig)) %>% filter(some_sig == TRUE)
#Set values on axes limits to facilitate plotting
bootstrap_Bca_CI_filtered$Bca_sup[bootstrap_Bca_CI_filtered$Bca_sup > orlimR] <- orlimR
bootstrap_Bca_CI_filtered$Bca_sup[bootstrap_Bca_CI_filtered$Bca_sup == 0] <- orlimR
bootstrap_Bca_CI_filtered$Bca_inf[bootstrap_Bca_CI_filtered$Bca_inf < orlimL] <- orlimL

#Filter for those that are sig in some:
bootstrap_Bca_CI_filtered_2 <- bootstrap_Bca_CI_2 %>% group_by(regressor) %>% mutate(some_sig= any(is_sig)) %>% filter(some_sig == TRUE)
#Set values on axes limits to facilitate plotting
bootstrap_Bca_CI_filtered_2$Bca_sup[bootstrap_Bca_CI_filtered_2$Bca_sup > orlimR] <- orlimR
bootstrap_Bca_CI_filtered_2$Bca_sup[bootstrap_Bca_CI_filtered_2$Bca_sup == 0] <- orlimR
bootstrap_Bca_CI_filtered_2$Bca_inf[bootstrap_Bca_CI_filtered_2$Bca_inf < orlimL] <- orlimL


plotdata_filtered <- plotdata %>% filter(plotdata$regressor %in% bootstrap_Bca_CI_filtered$regressor) 


p  <- ggplot(aes(x = regressor, y = OR, color = group, fill = group),data = plotdata_filtered) +
  geom_hline(yintercept = 1 , color = "grey", linetype = "dotted",
             size = 1) +
  # geom_violin(alpha = 0.15, trim = TRUE, position = position_dodge(width = 0.8), size = 0.1) +
  geom_pointrange(data = bootstrap_Bca_CI_filtered,
                  aes(ymin=Bca_inf, ymax = Bca_sup, shape = is_sig, color = group, fill = group),
                  position = position_dodge(width = 0.7), size = 1, linetype = 1) +
  # geom_pointrange(data = bootstrap_Bca_CI_filtered_2,
  #                 aes(ymin=Bca_inf, ymax = Bca_sup, shape = is_sig, color = group, fill = group),
  #                 position = position_dodge(width = 0.7), size = pointrange2size) +
  # # geom_point(data = bootstrap_Bca_CI, 
  #            aes(shape = is_sig, fill = group),
  #            position = position_dodge(width = 0.8), size = 2) +
    scale_color_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                     limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
     scale_fill_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                     limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
 scale_shape_manual(values = c(1,16)) +
  scale_y_log10(limits=c(orlimL,orlimR)) +
  # scale_x_discrete(labels=parse(text=unique(bootstrap_Bca_CI$regressor)))
  # ylim(1/35, 35) +
  guides(shape = FALSE) +
  theme_classic() +
  # theme(legend.position = c(0.8,0.9),
  #       legend.title = element_blank(),
  #       legend.box = "vertical",
  #       legend.text = element_text(size = 20),
  #       plot.title =  element_text(size = 24,
  #                                 hjust = 0),
  #       panel.grid.minor.y = element_blank(),
  #       axis.line = element_line(colour="black"),
  #       axis.title.y = element_blank(),
  #       axis.title.x = element_text(size = 24),
  #       axis.text = element_text(size = 22),
  #       panel.grid.major.y = element_blank()) +
  coord_flip() +
  xlab("Robust standardized coefficient") +
  labs(title = "PREDICTORS OF WORSENED SELF-RATED HEALTH \nBETWEEN QUESTIONNAIRES",
       subtitle = "") +
   theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 14, angle = 30,hjust = 0.8),
        plot.title =  element_text(size = 16),
        plot.subtitle = element_text(size = 16,
                                     hjust = 0.5))

p

```

```{r}

p <- p +   labs(title = NULL,subtitle = NULL)
ggplot2::ggsave(filename = "../results/figures/exp_small_log_reg_results_b.pdf",
                plot= p,
# do not change these rather just scale the ready pdf later if you need.
       width = 35,
       height = 25,
       dpi = 600,
       units = "cm")

```


#Big plot of all variables for supplement
```{r fig2, fig.height = 40, fig.width = 15}

bootstrap_Bca_CI$Bca_sup[bootstrap_Bca_CI$Bca_sup > orlimR] <- orlimR
bootstrap_Bca_CI$Bca_sup[bootstrap_Bca_CI$Bca_sup == 0] <- orlimR
bootstrap_Bca_CI$Bca_inf[bootstrap_Bca_CI$Bca_inf < orlimL] <- orlimL

#Set values on axes limits to facilitate plotting
bootstrap_Bca_CI_2$Bca_sup[bootstrap_Bca_CI_2$Bca_sup > orlimR] <- orlimR
bootstrap_Bca_CI_2$Bca_sup[bootstrap_Bca_CI_2$Bca_sup == 0] <- orlimR
bootstrap_Bca_CI_2$Bca_inf[bootstrap_Bca_CI_2$Bca_inf < orlimL] <- orlimL


p2  <- ggplot(aes(x = regressor, y = OR, color = group, fill = group),data = plotdata) +
  geom_hline(yintercept = 1 , color = "grey", linetype = "dotted",
             size = 1) +
  # geom_violin(alpha = 0.15, trim = TRUE, position = position_dodge(width = 0.8), size = 0.1) +
  geom_pointrange(data = bootstrap_Bca_CI,
                  aes(ymin=Bca_inf, ymax = Bca_sup, shape = is_sig, color = group, fill = group),
                  position = position_dodge(width = 0.7), size = 1, linetype = 2) +
  geom_pointrange(data = bootstrap_Bca_CI_2,
                  aes(ymin=Bca_inf, ymax = Bca_sup, shape = is_sig, color = group, fill = group),
                  position = position_dodge(width = 0.7), size = pointrange2size) +
  # # geom_point(data = bootstrap_Bca_CI, 
  #            aes(shape = is_sig, fill = group),
  #            position = position_dodge(width = 0.8), size = 2) +
    scale_color_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                     limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
     scale_fill_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                     limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
 scale_shape_manual(values = c(1,16)) +
  scale_y_log10(limits=c(orlimL,orlimR)) +
  # scale_x_discrete(labels=parse(text=unique(bootstrap_Bca_CI$regressor)))
  # ylim(1/35, 35) +
  guides(shape = FALSE) +
  theme_classic() +
  # theme(legend.position = c(0.8,0.9),
  #       legend.title = element_blank(),
  #       legend.box = "vertical",
  #       legend.text = element_text(size = 20),
  #       plot.title =  element_text(size = 24,
  #                                 hjust = 0),
  #       panel.grid.minor.y = element_blank(),
  #       axis.line = element_line(colour="black"),
  #       axis.title.y = element_blank(),
  #       axis.title.x = element_text(size = 24),
  #       axis.text = element_text(size = 22),
  #       panel.grid.major.y = element_blank()) +
  coord_flip() +
  xlab("Robust standardized coefficient") +
  labs(title = "PREDICTORS OF WORSENED SELF-RATED HEALTH \nBETWEEN QUESTIONNAIRES",
       subtitle = "") +
   theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 14, angle = 30,hjust = 0.8),
        plot.title =  element_text(size = 16),
        plot.subtitle = element_text(size = 16,
                                     hjust = 0.5))

p2
```



```{r}
p2 <- p2 +   labs(title = NULL,subtitle = NULL)
ggplot2::ggsave(filename = "../results/figures/exp_big_log_reg_results_b.pdf",
                plot= p2,
       width = 35,
       height = 55,
       dpi = 600,
       units = "cm")

```


#Separate plots for individual variables

```{r}
fig.width=15
fig.height=13
#Load questionnaire data
load(file = "../data/final_data.rdata") 
final_data <- data

```

## Change in physical condition color
```{r}

pdata <- final_data %>% 
  dplyr::select(donor, group, health, questionnaire) %>% 
  drop_na(group) %>% 
  filter( group != "Women_pre_menop_no_mens") %>% 
  spread(key = questionnaire, value = health) %>% 
  filter(First != "NA" & Second != "NA") %>%  
  mutate(Difference = case_when(First < Second ~ "Improved",
                                First == Second ~ "Stable",
                                TRUE ~ "Worsened")) %>% 
  inner_join(regression_data, by = c("donor", "group")) %>% 
  mutate(group = case_when(group == "Pre_menopause_women" ~ "Pre-menopausal \n women",
                           group == "Post_menopause_women" ~ "Post-menopausal \n women",
                           TRUE ~ "Men"),
         group = ordered(group, levels = c(  "Men", "Post-menopausal \n women", "Pre-menopausal \n women") ))
 
p <- ggplot(aes(x= phys_cond_d , fill = group), data=pdata) +
  # geom_hline(yintercept = 15, color = "red", linetype = 3)
  geom_bar()+
  #geom_boxplot(outlier.alpha = 0) +
  #geom_beeswarm(alpha = 0.5, shape = 1) +
  # scale_y_log10() +
  facet_grid(group ~ Difference,scales="free_y") +
  scale_fill_manual(values = c( "#ff85a2",  "#de2d26","#00BFFF" ),
                    limits = c("Pre-menopausal \n women", "Post-menopausal \n women","Men" )) +
  theme_bw() +
  theme(legend.position = "none") +
  ggtitle("Evolution of self-rated health") +
  xlab("Change in physical condition") +
  ylab("Count") +
  geom_text(stat='count', aes(label=..count..),color="black", vjust=1)  
#scale_y_log10() 



ggplot2::ggsave(plot=p,filename = "../results/figures/exp_phys_cond_c.pdf",
       width = fig.width,
       height = fig.height,
       dpi = 600,
       units = "cm")

p
```




## Quality of life
```{r}

p <- ggplot(aes(x= life_qual), data=pdata) +
  # geom_hline(yintercept = 15, color = "red", linetype = 3)
  geom_bar(aes(fill=group))+
  #geom_boxplot(outlier.alpha = 0) +
  #geom_beeswarm(alpha = 0.5, shape = 1) +
  # scale_y_log10() +
  facet_grid(group ~ Difference,scales="free_y") +
  theme_bw() +
  theme(legend.position = "none") +
  ggtitle("Evolution of self-rated health")+
  xlab("Quality of life") +
  ylab("Count") +
  geom_text(stat='count', aes(label=..count..),color="black", vjust=1) +
  scale_fill_manual(values = c( "#ff85a2",  "#de2d26","#00BFFF" ),
                     limits = c("Pre-menopausal \n women", "Post-menopausal \n women","Men" ))

ggplot2::ggsave(plot=p,filename = "../results/figures/exp_life_qual_c.pdf",
       width = fig.width,
       height = fig.height,
       dpi = 600,
       units = "cm")

p
```


   